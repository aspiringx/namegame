# Chat UX

**Date:** October 4, 2025  
**Status:** In Development - Phase 1 Core Features  
**Last Updated:** October 4, 2025 4:42 PM  
**Context:** Real-time chat integration with multi-group community platform

## Problem Statement

NameGame users belong to multiple groups and have relationships both within groups and across groups. Chat needs to be **user-centric** (not group-centric) while respecting the context of where conversations originate and who users can communicate with.

### Key Challenges
- Users need to chat across all their groups from a unified interface
- Permission model varies by context (group members vs established relationships)
- Mobile requires full-screen experience without losing current context
- Must feel intuitive despite underlying complexity

## Design Principles

### 1. User-Centric Chat
- Single unified chat interface across all groups
- Conversations persist regardless of current group context
- Chat badge shows aggregate unread count from all conversations

### 2. Context-Aware Permissions
- **Group Context**: Can message any current group member
- **Global Context**: Can only message people with established UserUser relationships
- **Group-wide**: Special broadcast to entire group

### 3. Familiar UX Patterns
- **Mobile**: Full-screen modal/drawer (like WhatsApp)
- **Desktop**: Top-right dropdown (like Facebook)
- **Navigation**: Clear close/back options to return to previous context

## UX Flow Design

### Mobile Chat Flow (Option A: Context-First)

```
1. Chat Badge (with unread count)
   ↓ [Tap]
   
2. Conversation List
   - Recent conversations (most recent first)
   - Context indicators (group name, global, etc.)
   - Two prominent action buttons:
     [+ New in Current Group] [+ New Global Message]
   ↓ [Tap new message]
   
3. Scope Selection
   - If "New in Current Group": Show current group members
   - If "New Global Message": Show UserUser connections
   - Special option: "Message Entire Group" (if in group context)
   ↓ [Select participants]
   
4. Chat Interface
   - Full-screen conversation
   - Clear header showing participants and context
   - Easy back/close to return to previous app context
```

### Desktop Chat Flow

```
Chat Icon (top-right) → Dropdown with:
- Recent conversations preview
- "View All Messages" → Full chat interface
- Quick actions based on current context
```

## Conversation Types & Database Mapping

### 1. Direct Messages (1-on-1 or small group)
- `ChatConversation.type = 'direct'`
- `ChatConversation.groupId = NULL` (global) or specific group
- Participants can be from same group or across groups

### 2. Group-wide Messages
- `ChatConversation.type = 'group'`
- `ChatConversation.groupId = [specific group]`
- All current group members are participants

### 3. Cross-Group Messages
- `ChatConversation.type = 'direct'`
- `ChatConversation.groupId = NULL`
- Only allowed between users with UserUser relationships

## Context Indicators

### Visual Cues for Conversation Origin
- **Group conversations**: Group name/icon in conversation list
- **Global conversations**: "Global" or person icons
- **Group-wide**: "Everyone in [Group Name]"

### Permission Clarity
- When starting new chat, clearly show available participant pool
- "Choose from [Current Group]" vs "Choose from Your Connections"

## Mobile UX Specifications

### Chat Badge
- Position: Bottom navigation (thumb-friendly)
- Shows aggregate unread count across all conversations
- Red badge for unread messages, gray when no unreads

### Full-Screen Modal
- Slides up from bottom (iOS) or slides in from right (Android)
- Clear "X" or back arrow to close
- Maintains previous app state when closed
- Smooth transitions to avoid jarring context switches

### Conversation List
- Most recent conversation at top
- Preview of last message
- Timestamp (relative: "2m ago", "Yesterday")
- Unread indicators per conversation
- Swipe actions for archive/delete (future)

## Desktop UX Specifications

### Top-Right Integration
- Chat icon next to notifications and profile
- Dropdown shows recent conversations
- Click "View All" opens dedicated chat interface
- Notification badges on icon

### Chat Interface Options
- **Option 1**: Dedicated chat page (like Facebook Messenger web)
- **Option 2**: Persistent sidebar (like Discord)
- **Option 3**: Modal overlay (like LinkedIn)

*Recommendation: Start with Option 1 (dedicated page) for simplicity*

## Implementation Priorities

### Phase 1: Core Chat Flow
1. Mobile conversation list with context-aware new message buttons
2. Basic participant selection (group vs global)
3. Full-screen chat interface with proper back navigation

### Phase 2: Context Refinements
1. Visual indicators for conversation types
2. Group-wide messaging
3. Desktop chat integration

### Phase 3: Advanced Features
1. Message search across conversations
2. Conversation management (archive, delete, mute)
3. Rich media sharing
4. Typing indicators and read receipts

## Success Metrics

### Usability
- Users can start appropriate conversations without confusion
- Clear understanding of who can see messages
- Smooth context switching between chat and main app

### Adoption
- High engagement with cross-group messaging
- Reduced reliance on external messaging apps
- Positive feedback on chat discoverability

## Implementation Strategy: Start Simple, Avoid Noise

### Core Philosophy
**Primary concern**: Chat must not become so "noisy" that people ignore everything. Better to start minimal and grow based on actual usage patterns than overwhelm users from the start.

### Initial Launch (Phase 1: Minimal Noise)
**What we'll build first:**
- **Direct messages only** - 1-on-1 or small group conversations
- **No group-wide broadcasts** initially
- **Conservative notification defaults** - only for direct messages to the user
- **Built-in noise controls** from day one:
  - Conversation-level muting
  - Clear unread management
  - Easy archive/dismiss options

**What we'll deliberately exclude initially:**
- Group-wide messaging (too high noise potential)
- Auto-notifications for group conversations user didn't initiate
- Complex notification preferences (keep simple)

### Iterative Refinement Strategy
1. **Monitor engagement patterns** - Are people using chat without getting overwhelmed?
2. **Gather specific feedback** - What additional features do they actually want?
3. **Data-driven expansion** - Add features based on real usage, not assumptions
4. **Gradual introduction** - Roll out group-wide features with careful controls

### Success Criteria for Phase 1
- High chat adoption without user complaints about noise
- Users keep notifications enabled (don't turn them off)
- Positive feedback on chat discoverability and usefulness
- Evidence that chat reduces reliance on external messaging apps

### Lessons from Previous Community App Failure
- **Communication bottleneck**: Only admin could message → solved by direct messaging
- **Noise problem**: "Weirdos" posting too much → solved by starting with 1-on-1 only
- **Engagement drop**: People ignored notifications → solved by conservative defaults

This approach aligns with the **Community OS vision**: start simple, grow modularly based on actual community needs rather than assumed features.

## Open Questions (For Future Phases)

1. **Group-wide message permissions**: Should any group member be able to message the entire group, or just admins?

2. **Cross-group discovery**: How do users find and connect with people from other groups they don't know yet?

3. **Notification strategy**: How do chat notifications integrate with the broader content notification system?

4. **Message retention**: How long should chat history be preserved? Should it vary by conversation type?

5. **Moderation**: What tools do group admins need for managing group-wide conversations?

This design balances the complexity of multi-group relationships with the need for intuitive, familiar chat UX patterns while prioritizing sustainable adoption over feature completeness.

---

## Implementation Status (Updated: Oct 4, 2025 4:42 PM)

### ✅ Completed Features

#### Core Infrastructure
- **Database Schema** - Complete
  - `chat_conversations` table with type (direct/group) and optional groupId
  - `chat_participants` table for conversation membership
  - `chat_messages` table with real-time triggers
  - PostgreSQL LISTEN/NOTIFY for real-time updates
  
- **Real-time Chat Server** - Complete
  - Socket.IO server on port 3001
  - JWT authentication
  - Room-based message broadcasting
  - Network access configured for mobile testing (0.0.0.0 binding)
  - CORS configured for local network IPs

- **API Endpoints** - Complete
  - GET `/api/chat/conversations` - List conversations with pagination
  - POST `/api/chat/conversations` - Create new conversation
  - GET `/api/chat/messages/[conversationId]` - Load messages with pagination
  - POST `/api/chat/messages/[conversationId]` - Send message

#### UI Components
- **Drawer System** - Complete
  - Reusable `<Drawer>` component for consistent slide-in UX
  - Responsive widths: 100% mobile, 400px desktop
  - Smooth animations and backdrop
  
- **ChatDrawer** - Complete
  - Conversation list with infinite scroll
  - "New in [Group]" and "New Global Message" buttons
  - Context-aware participant selection
  - Contained within drawer (no fullscreen takeover)
  
- **ChatInterface** - Complete
  - Real-time message sending/receiving via Socket.IO
  - Message grouping by date
  - Infinite scroll for message history
  - iPhone Messages-style UI with bubbles
  - Optimized photo loading (thumb.webp for avatars)
  - **iPhone-style timestamp reveal**:
    - Swipe left + hold anywhere → All timestamps appear
    - Messages shift left, timestamps in right margin
    - Release → Timestamps hide immediately
    - Desktop: Click + hold for same effect
  
- **ParticipantSelector** - Complete
  - Group member selection with search
  - Global connections selection
  - Optimized thumbnail photos via server action
  - Uses `getPhotoUrl()` utility for correct image sizes

#### Mobile Optimizations
- **Network Configuration** - Complete
  - Web server on 0.0.0.0 for iPhone testing
  - Chat server accessible from local network
  - Proper CORS for 192.168.x.x and 10.x.x.x ranges
  
- **Touch Interactions** - Complete
  - Swipe gesture detection for timestamps
  - Smooth animations matching iOS patterns
  - Proper touch event handling

- **Image Optimization** - Complete
  - Thumb.webp loading for fast 3G performance
  - Server action to fetch correct photo sizes
  - Retina-quality display (2x source size)

### 🚧 In Progress
- None currently

### 📋 Next Steps (Priority Order)

#### 1. Unread Message Indicators (Est: 3-4 hours)
**Goal:** Show users which conversations have new messages

**Database Changes:**
- Add `chat_conversation_reads` table:
  ```sql
  - conversationId (FK)
  - userId (FK)
  - lastReadMessageId (FK to chat_messages)
  - lastReadAt (timestamp)
  - UNIQUE(conversationId, userId)
  ```
- Or extend `chat_participants` with `lastReadMessageId` column

**Backend:**
- API endpoint: `POST /api/chat/conversations/[id]/mark-read`
- Include unread count in conversation list response
- Socket event when user reads messages (for multi-device sync)

**Frontend:**
- Blue dot indicator on ChatIcon (header) when any unread exists
- Blue dot on each conversation in list with unread messages
- Auto-mark as read when user enters conversation
- Real-time updates when messages arrive
- Don't count own messages as unread

**Edge Cases:**
- Multiple devices/tabs (use socket events)
- Offline → online sync
- Conversation deleted while unread

#### 2. Emoji Reactions (Est: 2-3 hours)
**Goal:** Let users react to messages with emojis

**Database Changes:**
- Create `chat_message_reactions` table:
  ```sql
  - id (PK)
  - messageId (FK to chat_messages)
  - userId (FK to users)
  - emoji (varchar, e.g., "👍", "❤️", "😂")
  - createdAt (timestamp)
  - UNIQUE(messageId, userId, emoji) -- one reaction per user per emoji
  ```

**Backend:**
- API endpoints:
  - `POST /api/chat/messages/[messageId]/reactions` - Add reaction
  - `DELETE /api/chat/messages/[messageId]/reactions/[emoji]` - Remove reaction
- Load reactions with messages (grouped by emoji with counts)
- Socket event to broadcast reactions in real-time

**Frontend:**
- Long-press (mobile) or right-click (desktop) on message → Emoji picker
- Display reactions below message bubble (emoji + count)
- Hover to see who reacted
- Optimistic updates for instant feedback
- Real-time reaction updates via socket
- Use library: `emoji-picker-react` or similar

**UI Details:**
- Picker shows common reactions: 👍 ❤️ 😂 😮 😢 🎉
- Reactions grouped: "👍 3" (you + 2 others)
- Click reaction to add/remove yours
- Smooth animations for adding/removing

#### 3. Image Sharing in Chat (Est: 2-3 hours)
**Goal:** Allow users to share photos in conversations

**Backend:**
- Extend `chat_messages` table:
  - Add `attachmentUrl` column (nullable varchar)
  - Add `attachmentType` column (nullable varchar: 'image', 'file', etc.)
- Image upload endpoint: `POST /api/chat/upload`
  - Use existing storage system (`uploadFile` from `@/lib/actions/storage`)
  - Generate multiple sizes (large, medium, thumb) like user photos
  - Return URL to store in message
- Update message API to handle attachment URLs

**Frontend:**
- Add image picker button next to message input (📷 icon)
- File input for selecting images
- Image preview before sending
- Display images in message bubbles:
  - Thumbnail in chat (clickable)
  - Full-size lightbox on click
  - Loading states while uploading
- Support common formats: JPG, PNG, HEIC, WebP
- Client-side validation:
  - Max file size (e.g., 10MB)
  - Image dimensions check
  - Format validation

**UI Details:**
- Camera icon button in message input area
- Preview thumbnail with X to cancel before sending
- Uploaded images show in bubble (max width 300px)
- Tap/click image → Full screen view with zoom
- Loading spinner during upload
- Error handling for failed uploads

**Technical Considerations:**
- Compress images client-side before upload (reduce bandwidth)
- Generate WebP versions for better compression
- Store original + optimized versions
- Lazy load images as user scrolls
- Cache images for faster re-display

### 🔮 Future Phases (Not Prioritized Yet)

#### Phase 2: Context Refinements
- Visual indicators for conversation types (group icon, global icon)
- Group-wide messaging (broadcast to all members)
- Desktop-optimized chat interface

#### Phase 3: Advanced Features
- Message search across conversations
- Conversation management (archive, mute, delete)
- Rich media sharing (images, files)
- Typing indicators
- Read receipts
- Message editing/deletion
- Reply threading

#### Phase 4: Notifications
- Push notifications for new messages
- Email digests for missed messages
- Notification preferences per conversation
- Integration with broader notification system

---

## Technical Notes

### Image Loading Strategy
- **Problem:** Photos stored in multiple sizes (large, medium, small, thumb)
- **Solution:** Use `getPhotoUrl(photo, { size: 'thumb' })` utility
- **Implementation:** Server actions load Photo entities and generate correct URLs
- **Result:** ~5-10KB thumbs instead of ~50KB+ medium images

### Real-time Architecture
- **Socket.IO** for bidirectional communication
- **PostgreSQL LISTEN/NOTIFY** for database-triggered events
- **Room-based broadcasting** for conversation isolation
- **JWT authentication** for secure socket connections

### Mobile Testing Setup
- Web: `pnpm dev:mobile` (binds to 0.0.0.0:3000)
- Chat: Automatically binds to 0.0.0.0:3001
- Access via Mac's local IP (e.g., 192.168.50.177:3000)

---

## Commit History
- **Oct 4, 2025 4:40 PM** - "Put chat experience in drawer and timestamps"
  - Converted modal to drawer system
  - Added iPhone-style swipe-to-reveal timestamps
  - Optimized photo loading with thumb.webp
  - Fixed mobile network access
