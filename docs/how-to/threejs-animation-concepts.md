# Three.js + Theatre.js Animation Architecture

## Overview

The "Speed of Love" animation sequence uses **Theatre.js as the single source of truth** for all animation orchestration. Theatre.js provides a visual timeline editor that controls timing, easing, and property values, while Three.js handles 3D rendering.

**Key Principle:** All animations are controlled by Theatre.js. No manual timing (setTimeout), no React state-based animations, no lerp calculations in code.

## Architecture

### Current Setup (Theatre.js Only)

```
animations.json (single config source)
         ↓
    theatreConfig.ts (Theatre.js initialization)
         ↓
    theatre-state.json (keyframes & timing)
         ↓
    Scene.tsx (reads Theatre.js values, renders)
         ↓
    Three.js (3D rendering)
```

### Component Flow

```
StarField.tsx
├── Loads scenes from animations.json
├── Gets duration from Theatre.js (getSceneDuration)
└── Passes currentScene to Scene.tsx

Scene.tsx
├── Reads Theatre.js animated values via useFrame
├── Updates React state with Theatre.js values
└── Renders components with Theatre.js-controlled properties

Theatre.js
├── Auto-plays timeline when scene loads
├── Provides animated values every frame
└── Handles all timing, easing, and interpolation
```

## Key Concepts

### Theatre.js Terminology

**Project:** Top-level container for all animations (e.g., "Speed of Love")

**Sheet:** Timeline for a single scene (e.g., "Scene 1", "Scene 2")
- One sheet = one scene
- Each sheet has its own timeline and duration

**Object:** Container for animated properties (e.g., "Scene 1 Animation")
- Properties like `starsOpacity`, `heroStarScale`, `cameraX`

**Track:** Animation data for a single property over time
- Contains keyframes with positions (time) and values

**Keyframe:** A point in time with a specific value
- Position: Time in seconds
- Value: Property value at that time
- Handles: Bezier curve for easing

**Static Override:** Initial value for a property before animation starts

### Timing

- **Duration:** Defined in `animations.json` in **seconds** (e.g., 2.5)
- **Keyframe Position:** Time in **seconds** (e.g., 0, 1.5, 2.5)
- **FPS:** Theatre.js editor uses 30 fps for visual scrubbing
- **Playback:** Runtime uses `requestAnimationFrame` (smooth, frame-independent)

## Configuration Files

### 1. `animations.json` - Single Source of Truth

**Location:** `/apps/web/public/docs/scripts/animations.json`

**Purpose:** Defines all scene content AND animation properties

**Contains:**
- Scene metadata (description, narration, sceneType)
- Camera settings (position, FOV)
- Visual elements (stars, colors, effects)
- Animation duration (in seconds)
- Theatre.js property definitions (types, ranges, defaults)

**Structure:**
```json
{
  "projectName": "Speed of Love",
  "scenes": [
    {
      "scene": 1,
      "description": "Stars fade in slowly",
      "narration": "Your universe has billions of stars...",
      "sceneType": "cosmicView",
      "cameraPosition": [0, 0, 150],
      "cameraFOV": 50,
      "primaryStars": { "count": 15, "radius": 100 },
      "animation": {
        "duration": 2.0,
        "properties": {
          "starsOpacity": {
            "type": "number",
            "range": [0, 1],
            "default": 0
          }
        }
      }
    }
  ]
}
```

**Used by:**
- `loadScript()` - Loads scene data
- `theatreConfig.ts` - Creates Theatre.js objects from animation properties
- `StarField.tsx` - Scene progression and UI
- `Scene.tsx` - Rendering configuration

### 2. `theatre-state.json` - Keyframe Data

**Location:** `/apps/web/public/docs/scripts/theatre-state.json`

**Purpose:** Stores keyframes and timeline data created in Theatre.js Studio

**Contains:**
- Keyframe positions and values
- Easing curves (Bezier handles)
- Static overrides (initial values)
- Track IDs and property mappings

**Generated by:** Theatre.js Studio visual editor
- Export via `exportTheatreState()` in browser console (dev mode only)

**Structure:**
```json
{
  "sheetsById": {
    "Scene 1": {
      "staticOverrides": {
        "byObject": {
          "Scene 1 Animation": {
            "starsOpacity": 0
          }
        }
      },
      "sequence": {
        "subUnitsPerUnit": 30,
        "length": 2.0,
        "type": "PositionalSequence",
        "tracksByObject": {
          "Scene 1 Animation": {
            "trackData": {
              "ASnwz1b_90": {
                "type": "BasicKeyframedTrack",
                "__debugName": "Scene 1 Animation:[\"starsOpacity\"]",
                "keyframes": [
                  {
                    "id": "K7wzPwT63h",
                    "position": 0,
                    "value": 0,
                    "connectedRight": true,
                    "handles": [0.5, 1, 0.5, 0],
                    "type": "bezier"
                  },
                  {
                    "id": "zDDIZ4fyFQ",
                    "position": 2.0,
                    "value": 1,
                    "handles": [0.5, 1, 0.5, 0],
                    "type": "bezier"
                  }
                ]
              }
            },
            "trackIdByPropPath": {
              "[\"starsOpacity\"]": "ASnwz1b_90"
            }
          }
        }
      }
    }
  }
}
```

**Used by:** `theatreConfig.ts` loads this when initializing the Theatre.js project

## Implementation Pattern

### Scene Setup (theatreConfig.ts)

1. **Load animations.json** - Get scene definitions and animation properties
2. **Create Theatre.js project** - Initialize with theatre-state.json
3. **Create sheets** - One per scene (e.g., "Scene 1", "Scene 2")
4. **Create objects** - Dynamically generate from animation.properties
5. **Export helpers** - `getSceneSheet()`, `getSceneAnimation()`, `getSceneDuration()`

### Scene Rendering (Scene.tsx)

1. **Auto-play on mount** - When scene loads, play Theatre.js timeline
2. **Read values in useFrame** - Every frame, read Theatre.js animated values
3. **Update React state** - Store Theatre.js values in state for rendering
4. **Render with values** - Pass Theatre.js values to components as props

**Example:**
```tsx
// Read Theatre.js values every frame
useFrame(() => {
  const animation = getSceneAnimation(currentScene.scene)
  if (!animation) return
  
  if (currentScene.scene === 1) {
    setTheatreStarsOpacity(animation.value.starsOpacity)
  }
})

// Render with Theatre.js values
<PrimaryStars opacity={theatreStarsOpacity} />
```

### Adding a New Animated Property

1. **Add to animations.json** - Define property type, range, default
2. **Add state in Scene.tsx** - Create React state to hold Theatre.js value
3. **Read in useFrame** - Read from Theatre.js animation object
4. **Use in render** - Pass to component as prop
5. **Create keyframes in Studio** - Open dev mode, adjust timeline, export state

## Scene-by-Scene Implementation

### Scene 1: Cosmic View (Stars Fade In)
- **Duration:** 2.0 seconds
- **Properties:** `starsOpacity` (0 → 1)
- **Renders:** BackgroundStars, PrimaryStars

### Scene 2: Focus Star (Hero Star Appears)
- **Duration:** 2.5 seconds
- **Properties:** 
  - `heroStarOpacity` (0 → 1)
  - `heroStarScale` (0 → 1)
  - `primaryStarsOpacity` (1.0 → 0.3) - dims other stars
- **Renders:** BackgroundStars, PrimaryStars, HeroStar

### Scene 3: Constellation Form
- **Duration:** 3.0 seconds
- **Properties:**
  - `primaryStarsOpacity` (0.3 → 1.0) - brighten stars
  - `constellationOpacity` (0 → 1.0) - fade in lines
- **Renders:** BackgroundStars, PrimaryStars, HeroStar, HeroConstellationLines
- **Special:** Twinkling enabled via sceneType check

### Scene 4: Orbit Change (Hero Travels)
- **Duration:** 10.0 seconds
- **Properties:**
  - `oldConstellationOpacity` (1.0 → 0) - fade out old lines
  - `oldPrimaryStarsOpacity` (1.0 → 0) - fade out old stars
  - `cameraX`, `cameraY`, `cameraZ` - camera movement
  - `heroStarX`, `heroStarY`, `heroStarZ` - hero star movement
  - `newPrimaryStarsOpacity` (0 → 1.0) - fade in new stars
  - `newConstellationOpacity` (0 → 1.0) - fade in new lines
- **Renders:** All components with dual constellations
- **Special:** Camera and hero star positions controlled by Theatre.js

## Best Practices

### ✅ DO

- **Define all timing in Theatre.js** - Use keyframes, not setTimeout
- **Use seeded random** - For deterministic star positions across scenes
- **Read Theatre.js values in useFrame** - Single source of truth for animation
- **Export state after changes** - Run `exportTheatreState()` in console
- **Use seconds for duration** - Consistent with Theatre.js
- **Add static overrides** - Set initial values in theatre-state.json

### ❌ DON'T

- **Don't use setTimeout** - Theatre.js handles all timing
- **Don't use React state for animation** - Theatre.js controls values
- **Don't use lerp in code** - Theatre.js handles interpolation
- **Don't duplicate config** - Single source of truth in animations.json
- **Don't hardcode timing** - Use Theatre.js keyframes
- **Don't mix animation systems** - Theatre.js only

## Development Workflow

### Editing Animations

1. **Start dev server** - Theatre.js Studio loads automatically
2. **Open browser** - Studio UI appears at top of page
3. **Select scene sheet** - Choose which scene to edit
4. **Scrub timeline** - Preview animation at any point
5. **Add/edit keyframes** - Click to add, drag to adjust
6. **Adjust easing** - Modify Bezier handles for smooth curves
7. **Export state** - Run `exportTheatreState()` in console
8. **Save file** - Replace theatre-state.json with exported JSON

### Adding New Scenes

1. **Add to animations.json** - Define scene config and animation properties
2. **Add to Scene.tsx** - Create state variables and useFrame logic
3. **Add to theatre-state.json** - Create sheet with staticOverrides
4. **Open Studio** - Create keyframes visually
5. **Export and save** - Update theatre-state.json

## Troubleshooting

### Animation not playing
- Check Theatre.js duration matches scene duration
- Verify sheet name matches scene number
- Check staticOverrides are set correctly

### Values not updating
- Ensure useFrame is reading correct scene animation
- Check property name matches animations.json exactly
- Verify React state is being updated

### Timing feels wrong
- Check keyframe positions in theatre-state.json
- Verify duration in animations.json (seconds, not milliseconds)
- Adjust easing curves in Theatre.js Studio

### Stars regenerating on scene change
- Ensure `seed` prop is set on PrimaryStars
- Same seed = same positions across scenes
- Different seed = different positions

## File Checklist

When adding/modifying animations, update these files:

- [ ] `animations.json` - Add/modify animation properties
- [ ] `theatre-state.json` - Add/modify keyframes (export from Studio)
- [ ] `Scene.tsx` - Add state variables and useFrame logic
- [ ] `types.ts` - Update Scene interface if adding new scene properties

## Summary

**Theatre.js is the single animation orchestrator.** All timing, easing, and property values come from Theatre.js. React components read these values and render accordingly. No manual timing, no state-based animations, no conflicts.

This architecture provides:
- ✅ Visual timeline editing
- ✅ Frame-by-frame debugging
- ✅ Consistent timing across all scenes
- ✅ Easy adjustment without code changes
- ✅ Single source of truth for animation
